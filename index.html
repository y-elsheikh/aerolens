<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroLens: TEMPO Predictive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

<style>
    :root {
        --bg-primary: #f3f4f6;
        --bg-secondary: #ffffff;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --color-indigo: #6366f1;
        --color-indigo-light: #e0e7ff;
    }
    body { font-family: 'Space Grotesk', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }

    /* Map container */
    #mapid { height: 100%; width: 100%; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: var(--bg-secondary) !important; color: var(--text-primary) !important; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

    /* Sidebar base */
    #sidebar { width: 16rem; transition: width 0.3s ease; overflow: hidden; }
    #sidebar.collapsed { width: 4rem; }
    #sidebar.collapsed .logo-text,
    #sidebar.collapsed .nav-label {display:none;}

    /* Make sidebar fixed on small screens (toggle via is-open) */
    @media (max-width: 768px) { 
        #sidebar { transform: translateX(-100%); position: fixed; height: 100vh; top: 0; left: 0; z-index: 60; }
        #sidebar.is-open { transform: translateX(0); }
    }

    /* When collapsed: hide labels and reduce padding so only icons show */
    #sidebar .logo-text { transition: opacity .18s ease, transform .18s ease; }
    #sidebar.collapsed .logo-text { opacity: 0; transform: translateX(-6px); width: 0; height: 0; overflow: hidden; visibility: hidden; }

    #sidebar .nav-label { transition: opacity .18s ease, transform .18s ease; }
    #sidebar.collapsed .nav-label { opacity: 0; transform: translateX(-6px); width: 0; height: 0; overflow: hidden; visibility: hidden; display: inline-block; }

    #sidebar .nav-item { display: flex; align-items: center; gap: .75rem; }
    #sidebar.collapsed .nav-item { justify-content: center; }

    /* collapse button visuals */
    .collapse-btn { display: inline-flex; align-items: center; justify-content: center; gap: .5rem; border-radius: .5rem; padding: .25rem; cursor: pointer; }
    .collapse-icon { transition: transform .22s cubic-bezier(.2,.9,.3,1); }
    #sidebar.collapsed .collapse-icon { transform: rotate(180deg); }

    /* loader overlay */
    #map-loader {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(243, 244, 246, 0.7);
        z-index: 1000; display: flex; align-items: center; justify-content: center;
        border-radius: 0.75rem;
    }

    .pollutant-btn {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        border: 1px solid transparent;
    }
    .pollutant-btn.active {
        background-color: var(--color-indigo);
        color: white;
        border-color: var(--color-indigo);
    }
    .pollutant-btn:not(.active) {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border-color: #d1d5db;
    }

    /* small tooltip-like title when collapsed (use native title attribute) */
    #sidebar.collapsed a[title]:hover::after {
        content: attr(title);
        position: fixed;
        left: 4.5rem;
        background: rgba(0,0,0,.8);
        color: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 120;
        white-space: nowrap;
    }

</style>
</head>
<body class="min-h-screen flex antialiased">

<!-- Sidebar -->
<div id="sidebar" class="bg-white text-gray-800 space-y-6 py-4 px-3 md:relative md:translate-x-0 shadow-xl rounded-r-xl">
    <div class="flex items-center justify-between px-2">
        <div class="flex items-center gap-3">
            <h1 style="font-weight:700;" class="text-xl font-extrabold tracking-wider text-indigo-600 logo-text">AeroLens</h1>
        </div>

        <div class="flex items-center gap-1">
            <!-- collapse/expand button -->
            <button id="collapse-btn" class="collapse-btn text-gray-500 hover:text-gray-900 focus:outline-none" aria-label="Collapse sidebar" title="Collapse sidebar" aria-pressed="false">
                <i data-lucide="chevron-left" class="w-5 h-5 collapse-icon"></i>
            </button>

            <!-- close button for small screens -->
            <button id="hamburger-icon" class="md:hidden text-gray-500 hover:text-gray-900 focus:outline-none" aria-label="Close sidebar on mobile">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <nav class="px-1">
        <ul class="space-y-2" id="sidebar-nav">
            <li>
                <a href="#" id="map-link" class="nav-item p-3 font-semibold bg-indigo-100 text-indigo-700 rounded-lg active-link" title="Map View">
                    <i data-lucide="map" class="w-5 h-5"></i>
                    <span class="nav-label">Map View</span>
                </a>
            </li>
            <li>
                <a href="#" id="dashboard-link" class="nav-item p-3 font-semibold text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900 transition duration-150" title="Dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="nav-label">Dashboard</span>
                </a>
            </li>
        </ul>
    </nav>

</div>

<!-- Main Content -->
<div id="content" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
    <button id="show-sidebar-btn" class="md:hidden fixed top-4 left-4 z-40 p-2 bg-indigo-600 rounded-full shadow-lg text-white" aria-label="Open sidebar"><i data-lucide="menu" class="w-6 h-6"></i></button>
    
    <div id="map-view" class="page active h-full">
        <div class="mb-6 p-4 bg-white rounded-xl shadow-lg flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 id="map-title" class="text-2xl md:text-3xl font-bold text-indigo-600">USA NO2 Concentration</h1>
                <span id="map-status" class="text-sm font-medium text-gray-500 flex items-center mt-1">Initializing...</span>
            </div>
            <div id="pollutant-toggle" class="flex items-center space-x-2 bg-gray-100 p-1 rounded-full">
                <button class="pollutant-btn active" data-species="NO2">NO2</button>
                <button class="pollutant-btn" data-species="O3">O3</button>
                <button class="pollutant-btn" data-species="HCHO">HCHO</button>
            </div>
        </div>
        <div id="mapid" class="h-[80vh] md:h-[85vh] w-full relative"></div>
    </div>

    <div id="dashboard-view" class="page hidden p-4">
        <h1 class="text-3xl font-bold text-indigo-300 mb-6">Dashboard</h1>
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-indigo-700/30 w-full max-w-2xl mx-auto">
            <h3 class="text-xl font-bold text-indigo-400 mb-4">Live AQI Calculator</h3>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="number" id="concentration-input" placeholder="Concentration (e.g., 45.5)" class="flex-1 p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                <select id="pollutant-select" class="p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
                    <option value="O3">Ozone (O3)</option> <option value="PM25">PM2.5</option> <option value="NO2">Nitrogen Dioxide (NO2)</option>
                </select>
                <button onclick="checkAqi()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Calculate</button>
            </div>
            <div id="forecast-output" class="mt-4 p-4 bg-gray-900/50 rounded-lg text-gray-300 border border-gray-700 min-h-[80px] flex items-center justify-center">
                <p class="text-sm text-gray-400">Enter values to calculate AQI.</p>
            </div>
        </div>

    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    lucide.createIcons();

    const sidebar = document.getElementById('sidebar');
    const showSidebarBtn = document.getElementById('show-sidebar-btn');
    const mapLink = document.getElementById('map-link');
    const dashboardLink = document.getElementById('dashboard-link');
    const mapView = document.getElementById('map-view');
    const dashboardView = document.getElementById('dashboard-view');
    const mapStatus = document.getElementById('map-status');
    const mapContainer = document.getElementById('mapid');
    const mapTitle = document.getElementById('map-title');
    const pollutantToggle = document.getElementById('pollutant-toggle');
    const collapseBtn = document.getElementById('collapse-btn');
    const hamburgerIcon = document.getElementById('hamburger-icon');


    const API_BASE_URL = 'http://127.0.0.1:8000';
    let map;
    let imageOverlay = null;
    let currentSpecies = 'NO2';

    function showMapLoader() {
        const loader = document.createElement('div');
        loader.id = 'map-loader';
        loader.innerHTML = `<i data-lucide="loader-2" class="w-12 h-12 animate-spin text-indigo-500"></i>`;
        mapContainer.appendChild(loader);
        lucide.createIcons();
    }

    function hideMapLoader() {
        const loader = document.getElementById('map-loader');
        if (loader) loader.remove();
    }

    function initMap() {
        if (!map) {
            map = L.map('mapid', { 
                zoomControl: false,
                maxBounds: L.latLngBounds(L.latLng(24, -125), L.latLng(49.5, -66.9)), // Restrict panning to USA.
                minZoom: 4.75,
		zoomSnap:.25
            }).setView([39.82, -98.57], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                // attribution: '© OpenStreetMap, © CARTO', 
                maxZoom: 19
            }).addTo(map);
        }
    }
    
    const gradient = [
        { pos: 0.0, hex: '#fca636' },
        { pos: 0.25, hex: '#e16462' },
        { pos: 0.5, hex: '#b12a90' },
        { pos: 0.75, hex: '#6a00a8' },
        { pos: 1.0, hex: '#0d0887' }
    ].map(c => ({ ...c, rgb: [parseInt(c.hex.slice(1,3), 16), parseInt(c.hex.slice(3,5), 16), parseInt(c.hex.slice(5,7), 16)] }));

    function getColor(value, min, max) {
        let position = (value - min) / (max - min);
        if (position > 1) position = 1;
        if (position < 0) position = 0;
        
        let i = 0;
        for (i = 0; i < gradient.length - 2; i++) {
            if (position <= gradient[i + 1].pos) break;
        }
        const p1 = gradient[i], p2 = gradient[i + 1];
        const t = (position - p1.pos) / (p2.pos - p1.pos);
        
        return [
            Math.round(p1.rgb[0] + t * (p2.rgb[0] - p1.rgb[0])),
            Math.round(p1.rgb[1] + t * (p2.rgb[1] - p1.rgb[1])),
            Math.round(p1.rgb[2] + t * (p2.rgb[2] - p1.rgb[2]))
        ];
    }

    async function fetchAndDrawSmoothHeatmap(species) {
        showMapLoader();
        mapTitle.textContent = `USA ${species} Concentration`;
        mapStatus.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Fetching high-res data for ${species}...`;
        lucide.createIcons();
        
        const bbox = { min_lon: -125.0, min_lat: 24.0, max_lon: -66.9, max_lat: 49.5 };
        const now = new Date();
        const endDate = now.toISOString().slice(0, 13);
        now.setDate(now.getDate() - 2);
        const startDate = now.toISOString().slice(0, 13);
        
        const params = new URLSearchParams({ 
            species: species, start_date: startDate, end_date: endDate, 
            lat_bins: 40, lon_bins: 40, 
            resolution_factor: 5
        });

        try {
            const response = await fetch(`${API_BASE_URL}/heatmap_data?${params.toString()}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bbox)
            });
            if (!response.ok) throw new Error(`Server Error (${response.status})`);
            
            const data = await response.json();
            if (imageOverlay) map.removeLayer(imageOverlay);

            const flatValues = data.values?.flat().filter(v => v !== null && v > 0);
            if (!flatValues || flatValues.length === 0) throw new Error("API returned an empty dataset.");

            flatValues.sort((a, b) => a - b);
            const minVal = flatValues[Math.floor(flatValues.length * 0.05)]; 
            const maxVal = flatValues[Math.floor(flatValues.length * 0.95)];

            const height = data.values.length;
            const width = data.values[0].length;
            
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(width, height);

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const value = data.values[y][x];
                    const index = (y * width + x) * 4;
                    if (value !== null && value > 0) {
                        const [r, g, b] = getColor(value, minVal, maxVal);
                        imageData.data[index] = r;
                        imageData.data[index + 1] = g;
                        imageData.data[index + 2] = b;
                        imageData.data[index + 3] = 200; 
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);

            const imageUrl = canvas.toDataURL();
            const imageBounds = [[bbox.min_lat, bbox.min_lon], [bbox.max_lat, bbox.max_lon]];
            imageOverlay = L.imageOverlay(imageUrl, imageBounds, { opacity: 0.5 });
            imageOverlay.addTo(map);
            
            mapStatus.innerHTML = `<i data-lucide="check-circle-2" class="w-4 h-4 mr-2 text-green-500"></i> High-Res ${species} Heatmap Loaded`;

        } catch (error) {
            console.error(error);
            let msg = error.message.includes("fetch") ? "Connection Failed. Is API running?" : error.message;
            mapStatus.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 mr-2 text-red-500"></i> Error: ${msg}`;
        } finally {
            hideMapLoader();
            lucide.createIcons();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        // On larger screens keep sidebar visible by default
        if (window.innerWidth > 768) sidebar.classList.add('is-open');

        // Correct mobile open/close
        hamburgerIcon.addEventListener('click', () => sidebar.classList.remove('is-open'));
        document.getElementById('hamburger-icon').addEventListener('click', () => sidebar.classList.remove('is-open'));
        showSidebarBtn.addEventListener('click', () => {
            // open and ensure it's not collapsed on mobile for discoverability
            sidebar.classList.add('is-open');
            sidebar.classList.remove('collapsed');
            collapseBtn.setAttribute('aria-pressed', 'false');
            collapseBtn.setAttribute('title', 'Collapse sidebar');
        });

        // collapse / expand
        collapseBtn.addEventListener('click', () => {
            const isCollapsed = sidebar.classList.toggle('collapsed');
            collapseBtn.setAttribute('aria-pressed', String(isCollapsed));
            collapseBtn.setAttribute('title', isCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
            // update accessible icon rotation handled by CSS
            // after width animation, refresh map size so it redraws correctly
            setTimeout(() => { if (map) map.invalidateSize(); }, 310);
        });

        // keyboard support for collapse button
        collapseBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                collapseBtn.click();
            }
        });

        // close button on small screens
        document.getElementById('hamburger-icon').addEventListener('click', () => sidebar.classList.remove('is-open'));

        mapLink.addEventListener('click', (e) => { e.preventDefault(); navigateTo(mapView, mapLink); });
        dashboardLink.addEventListener('click', (e) => { e.preventDefault(); navigateTo(dashboardView, dashboardLink); });

        pollutantToggle.addEventListener('click', (e) => {
            if (e.target.classList.contains('pollutant-btn')) {
                const selectedSpecies = e.target.dataset.species;
                if (selectedSpecies !== currentSpecies) {
                    currentSpecies = selectedSpecies;
                    pollutantToggle.querySelectorAll('.pollutant-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    fetchAndDrawSmoothHeatmap(currentSpecies);
                }
            }
        });

        // add titles to nav items to show when collapsed (native tooltip)
        document.querySelectorAll('#sidebar-nav a').forEach(a => { a.setAttribute('title', a.textContent.trim()); });

        fetchAndDrawSmoothHeatmap(currentSpecies);

        // when window resizes, ensure sidebar visibility/behavior remains sensible
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                // on mobile keep it hidden by default
                sidebar.classList.remove('is-open');
            } else {
                sidebar.classList.add('is-open');
            }
        });
    });
    
    function navigateTo(targetView, targetLink) {
         document.querySelectorAll('#sidebar-nav a').forEach(a => { 
             a.classList.remove('bg-indigo-100', 'text-indigo-700'); 
             a.classList.add('text-gray-600'); 
         });
        targetLink.classList.add('bg-indigo-100', 'text-indigo-700');
        document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
        targetView.classList.remove('hidden');
        if (targetView === mapView) { 
            initMap(); 
            setTimeout(() => map.invalidateSize(), 200); 
        }
        if (window.innerWidth <= 768) sidebar.classList.remove('is-open');
    }
    async function checkAqi() {
        const conc = document.getElementById('concentration-input').value; 
        const poll = document.getElementById('pollutant-select').value;
        const output = document.getElementById('forecast-output');
        output.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin text-indigo-500"></i>`;
        lucide.createIcons();
        if (!conc) { output.innerHTML = '<p class="text-red-500">Enter a concentration.</p>'; return; }
        try {
            const res = await fetch(`${API_BASE_URL}/aqi?pollutant=${poll}&concentration=${conc}`);
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || res.statusText);
            let color = data.category === 'Good' ? 'text-green-500' : data.category === 'Moderate' ? 'text-yellow-500' : 'text-red-500';
            output.innerHTML = `<div class="text-center"><p class="text-gray-500 text-sm">AQI Result</p><p class="text-4xl font-extrabold ${color} mt-1">${data.aqi}</p><p class="text-lg ${color} font-semibold uppercase">${data.category}</p></div>`;
        } catch (e) {
            output.innerHTML = `<p class="text-red-500 font-semibold">Error: ${e.message}</p>`;
        }
    }
</script>
</body>
</html>