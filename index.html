<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AeroLens: TEMPO Predictive Dashboard</title>

  <!-- Tailwind / Icons / Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    :root{
      --bg-primary:#f3f4f6; --bg-secondary:#ffffff;
      --text-primary:#1f2937; --text-secondary:#6b7280;
      --color-indigo:#6366f1; --color-indigo-light:#e0e7ff;
    }
    body{font-family:'Space Grotesk',sans-serif;background:var(--bg-primary);color:var(--text-primary);}
    #mapid{height:75%;width:100%;border-radius:.75rem;overflow:hidden;box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    .leaflet-popup-content-wrapper,.leaflet-popup-tip{background:var(--bg-secondary)!important;color:var(--text-primary)!important;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    #sidebar{width:16rem;transition:width .3s ease;overflow:hidden}
    #sidebar.collapsed{width:4rem}
    #sidebar.collapsed .logo-text,#sidebar.collapsed .nav-label{display:none}
    @media (max-width:768px){
      #sidebar{transform:translateX(-100%);position:fixed;height:100vh;top:0;left:0;z-index:60}
      #sidebar.is-open{transform:translateX(0)}
    }
    #sidebar .logo-text{transition:opacity .18s ease,transform .18s ease}
    #sidebar.collapsed .logo-text{opacity:0;transform:translateX(-6px);width:0;height:0;overflow:hidden;visibility:hidden}
    #sidebar .nav-label{transition:opacity .18s ease,transform .18s ease}
    #sidebar.collapsed .nav-label{opacity:0;transform:translateX(-6px);width:0;height:0;overflow:hidden;visibility:hidden;display:inline-block}
    #sidebar .nav-item{display:flex;align-items:center;gap:.75rem}
    #sidebar.collapsed .nav-item{justify-content:center}
    .collapse-btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:.5rem;padding:.25rem;cursor:pointer}
    .collapse-icon{transition:transform .22s cubic-bezier(.2,.9,.3,1)}
    #sidebar.collapsed .collapse-icon{transform:rotate(180deg)}
    #map-loader{position:absolute;inset:0;background:rgba(243,244,246,.7);z-index:1000;display:flex;align-items:center;justify-content:center;border-radius:.75rem}
    .pollutant-btn{padding:.5rem 1rem;border-radius:9999px;font-weight:600;cursor:pointer;transition:all .2s;border:1px solid transparent}
    .pollutant-btn.active{background:var(--color-indigo);color:#fff;border-color:var(--color-indigo)}
    .pollutant-btn:not(.active){background:var(--bg-secondary);color:var(--text-primary);border-color:#d1d5db}
    #sidebar.collapsed a[title]:hover::after{content:attr(title);position:fixed;left:4.5rem;background:rgba(0,0,0,.8);color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;z-index:120;white-space:nowrap}

    /* Timeseries modal */
    #timeseries-modal{position:fixed;inset:0;z-index:1050;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:opacity .3s ease}
    #timeseries-modal.visible{opacity:1;visibility:visible}
    .modal-content{background:#fff;border-radius:.75rem;padding:1.5rem;width:90%;max-width:600px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);transform:scale(.95);transition:transform .3s ease}
    #timeseries-modal.visible .modal-content{transform:scale(1)}

    /* Leaflet controls: search + theme */
    .al-control{background:#fff;border-radius:.5rem;box-shadow:0 1px 6px rgba(0,0,0,.15);padding:.5rem;display:flex;align-items:center;gap:.5rem}
    .al-search-input{border:1px solid #111;padding:.35rem .5rem;outline:none;width:220px;color:#111;background:#fff;border-radius:.375rem}
    .al-search-btn{border:1px solid #111;padding:.35rem .75rem;cursor:pointer;background:#f3f4f6;border-radius:.375rem}
    .al-theme-btn{border:1px solid #d1d5db;background:#fff;border-radius:.5rem;padding:.35rem .5rem;cursor:pointer;display:inline-flex;align-items:center;gap:.4rem}
    .al-fade{transition:opacity .3s ease}

    /* Legend */
    .al-legend{background:#fff;border-radius:.5rem;box-shadow:0 1px 6px rgba(0,0,0,.15);padding:.6rem .7rem;min-width:220px}
    .al-legend-title{font-weight:700;font-size:.85rem;margin-bottom:.25rem}
    .al-legend-bar{height:10px;border-radius:6px;width:100%;margin:.35rem 0}
    .al-legend-scale{display:flex;justify-content:space-between;font-size:.75rem;color:#4b5563}
  </style>
</head>
<body class="min-h-screen flex antialiased">
  <!-- Sidebar -->
  <div id="sidebar" class="bg-white text-gray-800 space-y-6 py-4 px-3 md:relative md:translate-x-0 shadow-xl rounded-r-xl">
    <div class="flex items-center justify-between px-2">
      <div class="flex items-center gap-3">
        <h1 style="font-weight:700" class="text-xl font-extrabold tracking-wider text-indigo-600 logo-text">AeroLens</h1>
      </div>
      <div class="flex items-center gap-1">
        <button id="collapse-btn" class="collapse-btn text-gray-500 hover:text-gray-900 focus:outline-none" aria-label="Collapse sidebar" title="Collapse sidebar" aria-pressed="false">
          <i data-lucide="chevron-left" class="w-5 h-5 collapse-icon"></i>
        </button>
        <button id="hamburger-icon" class="md:hidden text-gray-500 hover:text-gray-900 focus:outline-none" aria-label="Close sidebar on mobile">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
    </div>
    <nav class="px-1">
      <ul class="space-y-2" id="sidebar-nav">
        <li>
          <a href="#" id="map-link" class="nav-item p-3 font-semibold bg-indigo-100 text-indigo-700 rounded-lg active-link" title="Map View">
            <i data-lucide="map" class="w-5 h-5"></i><span class="nav-label">Map View</span>
          </a>
        </li>
        <li>
          <a href="#" id="dashboard-link" class="nav-item p-3 font-semibold text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900 transition duration-150" title="Dashboard">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="nav-label">Dashboard</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Main -->
  <div id="content" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
    <button id="show-sidebar-btn" class="md:hidden fixed top-4 left-4 z-40 p-2 bg-indigo-600 rounded-full shadow-lg text-white" aria-label="Open sidebar"><i data-lucide="menu" class="w-6 h-6"></i></button>

    <div id="map-view" class="page active h-full">
      <div class="mb-6 p-4 bg-white rounded-xl shadow-lg flex justify-between items-center flex-wrap gap-4">
        <div>
          <h1 id="map-title" class="text-2xl md:text-3xl font-bold text-indigo-600">USA NO2 Concentration</h1>
          <p class="text-sm font-medium text-gray-500">Click on the map to view a time-series for that location.</p>
          <span id="map-status" class="text-sm font-medium text-gray-500 flex items-center mt-1">Initializing...</span>
        </div>
        <div id="pollutant-toggle" class="flex items-center space-x-2 bg-gray-100 p-1 rounded-full">
          <button class="pollutant-btn active" data-species="NO2">NO2</button>
          <button class="pollutant-btn" data-species="O3">O3</button>
          <button class="pollutant-btn" data-species="HCHO">HCHO</button>
        </div>
      </div>
      <div id="mapid" class="h-[80vh] md:h-[85vh] w-full relative"></div>
    </div>

    <div id="dashboard-view" class="page hidden p-4">
      <h1 class="text-3xl font-bold text-indigo-300 mb-6">Dashboard</h1>
      <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-indigo-700/30 w-full max-w-2xl mx-auto">
        <h3 class="text-xl font-bold text-indigo-400 mb-4">Live AQI Calculator</h3>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="number" id="concentration-input" placeholder="Concentration (e.g., 45.5)" class="flex-1 p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
          <select id="pollutant-select" class="p-3 rounded-lg bg-gray-700 border border-gray-600 text-white">
            <option value="O3">Ozone (O3)</option>
            <option value="PM25">PM2.5</option>
            <option value="NO2">Nitrogen Dioxide (NO2)</option>
          </select>
          <button onclick="checkAqi()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Calculate</button>
        </div>
        <div id="forecast-output" class="mt-4 p-4 bg-gray-900/50 rounded-lg text-gray-300 border border-gray-700 min-h-[80px] flex items-center justify-center">
          <p class="text-sm text-gray-400">Enter values to calculate AQI.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Time-series Modal -->
  <div id="timeseries-modal" class="hidden">
    <div class="modal-content relative">
      <button id="modal-close-btn" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800" aria-label="Close time-series modal">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
      <h2 id="modal-title" class="text-xl font-bold text-indigo-600 mb-4">Time-series & Prediction</h2>
      <div id="chart-container" class="relative h-64 md:h-80">
        <canvas id="timeseries-chart"></canvas>
        <div id="chart-loader" class="absolute inset-0 flex items-center justify-center bg-white/70 rounded-lg hidden">
          <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-indigo-500"></i>
        </div>
      </div>
      <p id="chart-error" class="text-center text-red-500 mt-4 font-semibold hidden"></p>
    </div>
  </div>

  <script>
    lucide.createIcons();

    // --- Elements
    const sidebar = document.getElementById('sidebar');
    const showSidebarBtn = document.getElementById('show-sidebar-btn');
    const mapLink = document.getElementById('map-link');
    const dashboardLink = document.getElementById('dashboard-link');
    const mapView = document.getElementById('map-view');
    const dashboardView = document.getElementById('dashboard-view');
    const mapStatus = document.getElementById('map-status');
    const mapContainer = document.getElementById('mapid');
    const mapTitle = document.getElementById('map-title');
    const pollutantToggle = document.getElementById('pollutant-toggle');
    const collapseBtn = document.getElementById('collapse-btn');
    const hamburgerIcon = document.getElementById('hamburger-icon');

    // Modal
    const timeseriesModal = document.getElementById('timeseries-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalTitle = document.getElementById('modal-title');
    const chartLoader = document.getElementById('chart-loader');
    const chartError = document.getElementById('chart-error');
    const chartCanvas = document.getElementById('timeseries-chart').getContext('2d');

    // API & state
    const API_BASE_URL = 'http://127.0.0.1:8000';
    const US_BOUNDS = L.latLngBounds([24,-125],[49.5,-66.9]);

    let map, baseDark, baseLight, currentTheme = 'dark';
    let imageOverlay = null;
    let currentSpecies = 'NO2';
    let timeseriesChart = null;

    let searchPulseCircle = null;

    // cache for re-render on theme swap
    let lastValues = null, lastBBox = null, lastMin = null, lastMax = null;

    // Product names for timeseries endpoint
    const SPECIES_TO_PRODUCT_MAP = { NO2:'NO2', O3:'O3', HCHO:'HCHO' };

    // Palettes (low→high). We keep the same direction in both themes.
    const gradientDarkStops = [
      {pos:0.00, hex:'#0d0887'},
      {pos:0.25, hex:'#6a00a8'},
      {pos:0.50, hex:'#b12a90'},
      {pos:0.75, hex:'#e16462'},
      {pos:1.00, hex:'#fca636'}
    ];
    const gradientLightStops = [
      {pos:0.00, hex:'#440154'},
      {pos:0.25, hex:'#414487'},
      {pos:0.50, hex:'#2a788e'},
      {pos:0.75, hex:'#22a884'},
      {pos:1.00, hex:'#fde725'}
    ];
    function hexToRgb(hex){return [parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)];}
    function withRgb(stops){return stops.map(s=>({...s,rgb:hexToRgb(s.hex)}));}
    let currentGradient = withRgb(gradientDarkStops);

    function showMapLoader(){
      const loader = document.createElement('div');
      loader.id='map-loader';
      loader.innerHTML = `<i data-lucide="loader-2" class="w-12 h-12 animate-spin text-indigo-500"></i>`;
      mapContainer.appendChild(loader);
      lucide.createIcons();
    }
    function hideMapLoader(){const n=document.getElementById('map-loader'); if(n) n.remove();}

    function initMap(){
      if (map) return;
      map = L.map('mapid',{
        zoomControl:false,
        maxBounds:US_BOUNDS,
        minZoom:4.75,
        zoomSnap:.25
      }).setView([39.82,-98.57],4);

      // Base layers prepared for cross-fade
      baseDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19,opacity:1}).addTo(map);
      baseLight= L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19,opacity:0}).addTo(map);
      addSearchControl();
      addThemeToggle();
      addLegendControl();

      // map click → timeseries
      map.on('click', onMapClick);
    }

    // ------- Color utilities -------
    function getColor(value,min,max){
      let t=(value-min)/(max-min); if(t<0)t=0; if(t>1)t=1;
      let i=0; for(i=0;i<currentGradient.length-1;i++){ if(t<=currentGradient[i+1].pos) break; }
      const a=currentGradient[i], b=currentGradient[i+1];
      const tt = (t-a.pos)/(b.pos-a.pos || 1);
      return [
        Math.round(a.rgb[0]+tt*(b.rgb[0]-a.rgb[0])),
        Math.round(a.rgb[1]+tt*(b.rgb[1]-a.rgb[1])),
        Math.round(a.rgb[2]+tt*(b.rgb[2]-a.rgb[2]))
      ];
    }

    // ------- Legend control -------
    let legendControl, legendBar, legendMin, legendMax, legendTitle;
    function addLegendControl(){
      const Legend = L.Control.extend({
        options:{position:'bottomleft'},
        onAdd:function(){
          const c = L.DomUtil.create('div','al-legend');
          c.innerHTML = `
            <div class="al-legend-title" id="al-legend-title">Concentration</div>
            <div class="al-legend-bar" id="al-legend-bar"></div>
            <div class="al-legend-scale"><span id="al-legend-min">min</span><span id="al-legend-max">max</span></div>
          `;
          return c;
        }
      });
      legendControl = new Legend();
      legendControl.addTo(map);
      legendBar = document.getElementById('al-legend-bar');
      legendMin = document.getElementById('al-legend-min');
      legendMax = document.getElementById('al-legend-max');
      legendTitle = document.getElementById('al-legend-title');
      updateLegendBar();
    }
    function gradientCss(stops){
      const parts = stops.map(s=>`${s.hex} ${Math.round(s.pos*100)}%`);
      return `linear-gradient(to right, ${parts.join(',')})`;
    }
    function updateLegend(minV, maxV, labelText = `${currentSpecies} Concentration`) {
      if (labelText) legendTitle.textContent = labelText;
      updateLegendBar();  // keeps the gradient in sync with theme
      // NOTE: we intentionally do NOT touch legendMin/legendMax text ("min" / "max")
    }

    function updateLegendBar(){
      const stops = (currentTheme==='dark') ? gradientDarkStops : gradientLightStops;
      legendBar.style.background = gradientCss(stops);
      legendBar.style.border = currentTheme==='dark' ? '1px solid rgba(255,255,255,.2)' : '1px solid rgba(0,0,0,.1)';
    }

    // ------- Theme toggle with cross-fade -------
    function addThemeToggle(){
      const ThemeCtl = L.Control.extend({
        options:{position:'topright'},
        onAdd:function(){
          const c = L.DomUtil.create('div','al-control');
          const btn = L.DomUtil.create('button','al-theme-btn al-fade',c);
          btn.id='al-theme-btn';
          btn.innerHTML=`<i data-lucide="moon"></i><span>Dark</span>`;
          btn.style.opacity='0.95';

          btn.onclick = ()=> toggleTheme();
          L.DomEvent.disableClickPropagation(c);
          return c;
        }
      });
      new ThemeCtl().addTo(map);
      lucide.createIcons();
    }
    function toggleTheme(){
      const target = (currentTheme==='dark')?'light':'dark';
      crossFadeBase(target);
      currentTheme = target;
      currentGradient = withRgb(currentTheme==='dark'?gradientDarkStops:gradientLightStops);
      updateLegendBar();
      // re-render heatmap with the same data
      if (lastValues && lastMin!=null && lastMax!=null){
        renderHeatmap(lastValues,lastBBox,lastMin,lastMax,true);
      }
      // update button content
      const btn = document.getElementById('al-theme-btn');
      if (btn){
        btn.innerHTML = currentTheme==='dark'
          ? `<i data-lucide="moon"></i><span>Dark</span>`
          : `<i data-lucide="sun"></i><span>Light</span>`;
        lucide.createIcons();
      }
    }
    function crossFadeBase(theme){
      // simple 300ms fade using requestAnimationFrame
      const duration=300;
      const start=performance.now();
      const fromDark = (theme==='light') ? 1 : 0; // dark opacity start
      const toDark   = (theme==='light') ? 0 : 1;
      function step(now){
        const t=Math.min(1,(now-start)/duration);
        const darkOp = fromDark + (toDark-fromDark)*t;
        baseDark.setOpacity(darkOp);
        baseLight.setOpacity(1-darkOp);
        if (t<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ------- Search control (US-only, typing works) -------
    function addSearchControl(){
      const SearchCtl = L.Control.extend({
        options:{position:'topright'},
        onAdd:function(){
          const c = L.DomUtil.create('div','al-control');
          const form = L.DomUtil.create('form','',c);
          form.setAttribute('autocomplete','off');
          form.style.display='flex';
          form.style.alignItems='center';
          form.style.gap='.5rem';

          const input = L.DomUtil.create('input','al-search-input',form);
          input.type='text'; input.placeholder='Search US place…'; input.ariaLabel='Search';

          const btn = L.DomUtil.create('button','al-search-btn',form);
          btn.type='submit'; btn.textContent='Go';

          // prevent map from stealing focus/keys
          L.DomEvent.disableClickPropagation(c);
          L.DomEvent.disableScrollPropagation(c);
          ['keydown','keyup','keypress','click'].forEach(ev=>{
            L.DomEvent.on(input,ev,e=>e.stopPropagation());
          });

          L.DomEvent.on(form,'submit', async (e)=>{
            e.preventDefault();
            const q=input.value.trim(); if(!q) return;
            try{
              const url=`https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&limit=1&q=${encodeURIComponent(q)}`;
              const res=await fetch(url,{headers:{'Accept':'application/json'}});
              const data=await res.json();
              if(Array.isArray(data)&&data.length>0){
                const {lat,lon,display_name}=data[0];
                const target=L.latLng(parseFloat(lat),parseFloat(lon));
                if(!US_BOUNDS.contains(target)){ alert('Outside the supported US area.'); return; }
                const targetZoom=Math.max(map.getMinZoom(),Math.min(8,map.getMaxZoom()));
                map.flyTo(target,targetZoom,{animate:true,duration:1.2});



                // Drop a temporary circle marker at the result and remove it after a bit
                // Drop a temporary circle marker at the result and remove it after a bit
                if (searchPulseCircle) {
                  map.removeLayer(searchPulseCircle);
                  searchPulseCircle = null;
                }
                searchPulseCircle = L.circleMarker(target, {
                  radius: 10,
                  color: currentTheme === 'dark' ? '#93c5fd' : '#2563eb',
                  weight: 2,
                  fillColor: currentTheme === 'dark' ? '#60a5fa' : '#3b82f6',
                  fillOpacity: 0.35
                }).addTo(map);

                // Keep it fully visible for longer, then slow-fade
                const VISIBLE_MS = 2500;   // was ~1200ms — now ~4.5s fully visible
                const FADE_STEPS = 15;     // was ~6 — more steps = smoother/longer fade
                const FADE_INTERVAL = 80; // 160ms * 15 ≈ 2.4s fade duration

                setTimeout(() => {
                  if (!searchPulseCircle) return;
                  let step = 0;
                  const startFill = 0.35;
                  const startStroke = 1.0;

                  const fade = setInterval(() => {
                    if (!searchPulseCircle) { clearInterval(fade); return; }
                    const t = step / FADE_STEPS;
                    const fill = Math.max(0, startFill * (1 - t));
                    const stroke = Math.max(0, startStroke * (1 - t));
                    searchPulseCircle.setStyle({ fillOpacity: fill, opacity: stroke });
                    step++;
                    if (step > FADE_STEPS) {
                      clearInterval(fade);
                      if (searchPulseCircle) { map.removeLayer(searchPulseCircle); searchPulseCircle = null; }
                    }
                  }, FADE_INTERVAL);
                }, VISIBLE_MS);



              }else{ alert('No US results found.'); }
            }catch(err){ console.error(err); alert('Search failed.'); }
          });
          return c;
        }
      });
      new SearchCtl().addTo(map);
    }

    // ------- Heatmap fetch + render -------
    async function fetchAndDrawSmoothHeatmap(species){
      showMapLoader();
      mapTitle.textContent=`USA ${species} Concentration`;
      mapStatus.innerHTML=`<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Fetching high-res data for ${species}...`;
      lucide.createIcons();

      const bbox={min_lon:-125.0,min_lat:24.0,max_lon:-66.9,max_lat:49.5};
      // fixed demo window
      const startDate="2025-10-02 00";
      const endDate  ="2025-10-02 23:59:59";

      const params = new URLSearchParams({
        species, start_date:startDate, end_date:endDate,
        lat_bins:40, lon_bins:40, resolution_factor:5
      });

      try{
        const response = await fetch(`${API_BASE_URL}/heatmap_data?${params.toString()}`,{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(bbox)
        });
        if(!response.ok) throw new Error(`Server Error (${response.status})`);
        const data = await response.json();
        const values = data.values;

        // guard
        const flat = values?.flat().filter(v=>v!==null && v>0);
        if(!flat || flat.length===0) throw new Error('API returned an empty dataset.');

        flat.sort((a,b)=>a-b);
        const minVal = flat[Math.floor(flat.length*0.05)];
        const maxVal = flat[Math.floor(flat.length*0.95)];

        // cache for theme re-render
        lastValues = values; lastBBox = bbox; lastMin=minVal; lastMax=maxVal;

        renderHeatmap(values,bbox,minVal,maxVal,false);
        mapStatus.innerHTML=`<i data-lucide="check-circle-2" class="w-4 h-4 mr-2 text-green-500"></i> High-Res ${species} Heatmap Loaded`;
        updateLegend(minVal,maxVal,`${species} Concentration`);
      }catch(err){
        console.error(err);
        const msg = String(err?.message||err);
        const pretty = /fetch/i.test(msg) ? 'Connection Failed. Is API running?' : msg;
        mapStatus.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 mr-2 text-red-500"></i> Error: ${pretty}`;
      }finally{
        hideMapLoader(); lucide.createIcons();
      }
    }

    function renderHeatmap(values,bbox,minVal,maxVal,themeSwap=false){
      const h = values.length, w = values[0].length;
      const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx=canvas.getContext('2d'); const imageData=ctx.createImageData(w,h);
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const v = values[y][x]; const idx=(y*w+x)*4;
          if(v!==null && v>0){
            const [r,g,b] = getColor(v,minVal,maxVal);
            imageData.data[idx]=r; imageData.data[idx+1]=g; imageData.data[idx+2]=b; imageData.data[idx+3]=200;
          }
        }
      }
      ctx.putImageData(imageData,0,0);
      const url=canvas.toDataURL();
      const bounds = [[bbox.min_lat,bbox.min_lon],[bbox.max_lat,bbox.max_lon]];
      if(!imageOverlay){
        imageOverlay = L.imageOverlay(url,bounds,{opacity:.5}).addTo(map);
      }else{
        if (typeof imageOverlay.setUrl === 'function'){
          imageOverlay.setUrl(url);
        }else{
          map.removeLayer(imageOverlay);
          imageOverlay = L.imageOverlay(url,bounds,{opacity:.5}).addTo(map);
        }
      }
      if(themeSwap){
        // subtle fade on theme swap
        imageOverlay.setOpacity(0.35);
        setTimeout(()=>imageOverlay.setOpacity(0.5),120);
      }
    }

    // ------- Timeseries -------
    async function onMapClick(e){
      const {lat,lng}=e.latlng;
      openTimeseriesModal(lat,lng);

      const bbox_size=0.5;
      const bbox={min_lon:lng-bbox_size/2,min_lat:lat-bbox_size/2,max_lon:lng+bbox_size/2,max_lat:lat+bbox_size/2};
      const demo_day='2025-10-01';
      const product = SPECIES_TO_PRODUCT_MAP[currentSpecies];
      const params = new URLSearchParams({day:demo_day,product});

      try{
        const res = await fetch(`${API_BASE_URL}/spatially_averaged_timeseries?${params.toString()}`,{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(bbox)
        });

        const text = await res.text();
        let payload; try{ payload = JSON.parse(text); }catch{}
        if(!res.ok){
          const detail = payload?.detail || text || res.statusText;
          if(res.status===404 || /No time series data/i.test(detail)){
            chartLoader.classList.add('hidden');
            chartError.textContent = `No time-series data for ${currentSpecies} at this location (demo date). Try nearby.`;
            chartError.classList.remove('hidden');
            return;
          }
          throw new Error(detail);
        }

        const data = Array.isArray(payload) ? payload : (payload.series ?? []);
        if(!data || data.length===0){
          chartLoader.classList.add('hidden');
          chartError.textContent = `No time-series data available.`;
          chartError.classList.remove('hidden');
          return;
        }
        displayTimeseriesChart(data);
      }catch(error){
        console.error('Time-series fetch error:',error);
        chartLoader.classList.add('hidden');
        chartError.textContent = `Error: ${error.message}`;
        chartError.classList.remove('hidden');
      }
    }

    function openTimeseriesModal(lat,lng){
      timeseriesModal.classList.remove('hidden');
      setTimeout(()=>timeseriesModal.classList.add('visible'),10);
      modalTitle.textContent = `${currentSpecies} Time-series & Prediction for Lat: ${lat.toFixed(2)}, Lon: ${lng.toFixed(2)}`;
      chartLoader.classList.remove('hidden'); chartError.classList.add('hidden');
      if(timeseriesChart){ timeseriesChart.destroy(); timeseriesChart=null; }
    }
    function closeTimeseriesModal(){
      timeseriesModal.classList.remove('visible');
      setTimeout(()=>timeseriesModal.classList.add('hidden'),300);
    }

    function displayTimeseriesChart(data){
      chartLoader.classList.add('hidden');
      const actualData = data.filter(d=>d.type==='actual');
      const predictedData = data.filter(d=>d.type==='predicted');
      if(actualData.length && predictedData.length){ predictedData.unshift(actualData[actualData.length-1]); }

      const cfg = {
        type:'line',
        data:{
          datasets:[
            {
              label:`Actual ${currentSpecies}`,
              data: actualData.map(d=>({x:new Date(d.time), y:d.value})),
              borderColor:'rgb(99,102,241)',
              backgroundColor:'rgba(99,102,241,.2)',
              borderWidth:2, pointRadius:1, pointBackgroundColor:'rgb(99,102,241)', fill:true, tension:.1
            },
            {
              label:`Predicted ${currentSpecies}`,
              data: predictedData.map(d=>({x:new Date(d.time), y:d.value})),
              borderColor:'rgb(236,72,153)', borderWidth:2, borderDash:[5,5],
              pointRadius:1, pointBackgroundColor:'rgb(236,72,153)', fill:false, tension:.1
            }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{type:'time', time:{unit:'hour', tooltipFormat:'MMM d, HH:mm', displayFormats:{hour:'HH:mm'}}, title:{display:true,text:'Time (UTC)'}},
            y:{title:{display:true,text:'Concentration'}}
          },
          plugins:{legend:{position:'top'}, tooltip:{mode:'index',intersect:false}}
        }
      };
      timeseriesChart = new Chart(chartCanvas,cfg);
    }

    // ------- Navigation & UI -------
    function navigateTo(targetView,targetLink){
      document.querySelectorAll('#sidebar-nav a').forEach(a=>{a.classList.remove('bg-indigo-100','text-indigo-700'); a.classList.add('text-gray-600');});
      targetLink.classList.add('bg-indigo-100','text-indigo-700');
      document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
      targetView.classList.remove('hidden');
      if(targetView===mapView){ initMap(); setTimeout(()=>map.invalidateSize(),200); }
      if(window.innerWidth<=768) sidebar.classList.remove('is-open');
    }

    async function checkAqi(){
      const conc=document.getElementById('concentration-input').value;
      const poll=document.getElementById('pollutant-select').value;
      const output=document.getElementById('forecast-output');
      output.innerHTML=`<i data-lucide="loader-2" class="w-6 h-6 animate-spin text-indigo-500"></i>`; lucide.createIcons();
      if(!conc){ output.innerHTML='<p class="text-red-500">Enter a concentration.</p>'; return; }
      try{
        const res=await fetch(`${API_BASE_URL}/aqi?pollutant=${poll}&concentration=${conc}`);
        const data=await res.json();
        if(!res.ok) throw new Error(data.detail||res.statusText);
        const color = data.category==='Good' ? 'text-green-500' : data.category==='Moderate' ? 'text-yellow-500' : 'text-red-500';
        output.innerHTML = `<div class="text-center"><p class="text-gray-500 text-sm">AQI Result</p><p class="text-4xl font-extrabold ${color} mt-1">${data.aqi}</p><p class="text-lg ${color} font-semibold uppercase">${data.category}</p></div>`;
      }catch(e){
        output.innerHTML=`<p class="text-red-500 font-semibold">Error: ${e.message}</p>`;
      }
    }

    // ------- Events -------
    document.addEventListener('DOMContentLoaded',()=>{
      initMap();
      if(window.innerWidth>768) sidebar.classList.add('is-open');

      hamburgerIcon.addEventListener('click',()=>sidebar.classList.remove('is-open'));
      showSidebarBtn.addEventListener('click',()=>{
        sidebar.classList.add('is-open'); sidebar.classList.remove('collapsed');
        collapseBtn.setAttribute('aria-pressed','false'); collapseBtn.setAttribute('title','Collapse sidebar');
      });
      collapseBtn.addEventListener('click',()=>{
        const isCollapsed=sidebar.classList.toggle('collapsed');
        collapseBtn.setAttribute('aria-pressed',String(isCollapsed));
        collapseBtn.setAttribute('title',isCollapsed?'Expand sidebar':'Collapse sidebar');
        setTimeout(()=>{ if(map) map.invalidateSize(); },310);
      });

      mapLink.addEventListener('click',(e)=>{e.preventDefault(); navigateTo(mapView,mapLink);});
      dashboardLink.addEventListener('click',(e)=>{e.preventDefault(); navigateTo(dashboardView,dashboardLink);});

      pollutantToggle.addEventListener('click',(e)=>{
        if(e.target.classList.contains('pollutant-btn')){
          const sel=e.target.dataset.species;
          if(sel!==currentSpecies){
            currentSpecies=sel;
            pollutantToggle.querySelectorAll('.pollutant-btn').forEach(b=>b.classList.remove('active'));
            e.target.classList.add('active');
            fetchAndDrawSmoothHeatmap(currentSpecies);
          }
        }
      });

      modalCloseBtn.addEventListener('click',closeTimeseriesModal);
      timeseriesModal.addEventListener('click',(e)=>{ if(e.target===timeseriesModal) closeTimeseriesModal(); });

      // initial data
      fetchAndDrawSmoothHeatmap(currentSpecies);

      window.addEventListener('resize',()=>{
        if(window.innerWidth<=768){ sidebar.classList.remove('is-open'); }
        else{ sidebar.classList.add('is-open'); }
      });
    });
  </script>
</body>
</html>
